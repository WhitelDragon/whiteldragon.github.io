{%- comment -%}
Универсальная обёртка для уже готовых ссылок на файлы.

Как пользоваться в постах:
  {% include media.html f="/assets/img/2025/slug/photo.jpg" alt="..." %}
  {% include media.html f="/assets/video/2025/slug/clip.mp4" cap="..." poster="/assets/img/2025/slug/poster.jpg" %}
  {% include media.html f="/assets/audio/2025/slug/voice.m4a" cap="..." %}

Параметры:
  f        — обязателен. Абсолютный путь (/assets/...) или внешний URL (http/https)
  alt      — alt-текст (для <img>)
  cap      — подпись (figcaption)
  class    — доп. классы на <figure>
  width,height — размеры (для <img>)
  poster   — для видео: путь к постеру (также абсолютный или URL)
  preload  — 'metadata' (по умолчанию), 'auto', 'none'
  autoplay, muted, loop — флаги для видео
{%- endcomment -%}

{%- assign src = include.f | default: include.src | default: '' | strip -%}
{%- unless src == '' or src == nil -%}

  {%- assign ext = src | split: '.' | last | downcase -%}
  {%- assign is_http = src contains '://' -%}
  {%- if is_http -%}
    {%- assign url = src -%}
  {%- else -%}
    {%- assign url = src | relative_url -%}
  {%- endif -%}

  {%- assign img_exts = 'jpg,jpeg,png,webp,gif,avif,svg' | split: ',' -%}
  {%- assign vid_exts = 'mp4,webm,ogv' | split: ',' -%}
  {%- assign aud_exts = 'mp3,ogg,wav,m4a,flac' | split: ',' -%}

  {%- if img_exts contains ext -%}
    {%- assign kind = 'img' -%}
  {%- elsif vid_exts contains ext -%}
    {%- assign kind = 'video' -%}
  {%- elsif aud_exts contains ext -%}
    {%- assign kind = 'audio' -%}
  {%- else -%}
    {%- assign kind = 'file' -%}
  {%- endif -%}

  {%- comment -%} постер для видео {%- endcomment -%}
  {%- assign poster_attr = '' -%}
  {%- if include.poster and include.poster != '' -%}
    {%- assign p = include.poster | strip -%}
    {%- assign p_is_http = p contains '://' -%}
    {%- if p_is_http -%}
      {%- assign poster_url = p -%}
    {%- else -%}
      {%- assign poster_url = p | relative_url -%}
    {%- endif -%}
    {%- assign poster_attr = ' poster="' | append: poster_url | append: '"' -%}
  {%- endif -%}

  {%- assign figure_class = 'media media-' | append: kind -%}
  {%- if include.class and include.class != '' -%}
    {%- assign figure_class = figure_class | append: ' ' | append: include.class -%}
  {%- endif -%}

  {%- capture caption_html -%}{% if include.cap and include.cap != '' %}<figcaption>{{ include.cap }}</figcaption>{% endif %}{%- endcapture -%}

  {%- if kind == 'img' -%}
    <figure class="{{ figure_class }}">
      <img src="{{ url }}"
           alt="{{ include.alt | default: '' | escape }}"
           loading="lazy" decoding="async"{% if include.width %} width="{{ include.width | escape }}"{% endif %}{% if include.height %} height="{{ include.height | escape }}"{% endif %}>
      {{ caption_html }}
    </figure>

  {%- elsif kind == 'audio' -%}
    {%- assign mime = 'audio/' | append: ext -%}
    {%- if ext == 'm4a' -%}{% assign mime = 'audio/mp4' %}{%- endif -%}
    <figure class="{{ figure_class }}">
      <audio controls preload="{{ include.preload | default: 'metadata' }}">
        <source src="{{ url }}" type="{{ mime }}">
        Ваш браузер не поддерживает аудио.
      </audio>
      {{ caption_html }}
    </figure>

  {%- elsif kind == 'video' -%}
    {%- assign mime = 'video/' | append: ext -%}
    {%- if ext == 'ogv' -%}{% assign mime = 'video/ogg' %}{%- endif -%}
    <figure class="{{ figure_class }}">
      <video controls playsinline
             preload="{{ include.preload | default: 'metadata' }}"{{ poster_attr }}{% if include.autoplay %} autoplay{% endif %}{% if include.muted %} muted{% endif %}{% if include.loop %} loop{% endif %}
             style="max-width:100%">
        <source src="{{ url }}" type="{{ mime }}">
        Ваш браузер не поддерживает видео.
      </video>
      {{ caption_html }}
    </figure>

  {%- else -%}
    <p><a href="{{ url }}">{{ src }}</a></p>
  {%- endif -%}

{%- endunless -%}
