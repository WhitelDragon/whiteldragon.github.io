{%- assign f = include.f | append: '' | strip -%}
{%- unless f == '' -%}

{%- assign ext = f | split: '.' | last | downcase -%}

{%- assign year = page.date | date: '%Y' -%}
{%- if year == '' -%}{% assign year = 'misc' %}{% endif -%}

{%- assign slug_src = page.slug | default: page.title | default: page.url -%}
{%- assign slug_base = slug_src | split: '/' | last -%}
{%- assign slug = slug_base | slugify -%}

{%- assign is_url = f contains '://' -%}
{%- assign first_char = f | slice: 0,1 -%}
{%- assign is_root = first_char == '/' -%}

{%- assign ext_img = 'jpg,jpeg,png,webp,gif,avif,svg' | split: ',' -%}
{%- assign ext_vid = 'mp4,webm,ogv' | split: ',' -%}
{%- assign ext_aud = 'mp3,ogg,wav,m4a,flac' | split: ',' -%}

{%- if ext_img contains ext -%}
  {%- assign kind = 'img' -%}
{%- elsif ext_vid contains ext -%}
  {%- assign kind = 'video' -%}
{%- elsif ext_aud contains ext -%}
  {%- assign kind = 'audio' -%}
{%- else -%}
  {%- assign kind = 'file' -%}
{%- endif -%}

{%- if is_url or is_root -%}
  {%- assign url = f -%}
{%- else -%}
  {%- if kind == 'video' -%}{% assign folder = 'video' %}
  {%- elsif kind == 'audio' -%}{% assign folder = 'audio' %}
  {%- else -%}{% assign folder = 'img' %}{% endif -%}
  {%- assign url = '/assets/' | append: folder | append: '/' | append: year | append: '/' | append: slug | append: '/' | append: f -%}
{%- endif -%}
{%- assign url_rel = url | relative_url -%}

{%- assign poster_attr = '' -%}
{%- if include.poster and include.poster != '' -%}
  {%- assign p = include.poster | append: '' | strip -%}
  {%- assign is_p_url = p contains '://' -%}
  {%- assign p_first = p | slice: 0,1 -%}
  {%- assign is_p_root = p_first == '/' -%}
  {%- if is_p_url or is_p_root -%}
    {%- assign poster_url = p -%}
  {%- else -%}
    {%- assign poster_url = '/assets/img/' | append: year | append: '/' | append: slug | append: '/' | append: p -%}
  {%- endif -%}
  {%- assign poster_attr = ' poster="' | append: (poster_url | relative_url) | append: '"' -%}
{%- endif -%}

{%- assign figure_class = 'media media-' | append: kind -%}
{%- if include.class and include.class != '' -%}
  {%- assign figure_class = figure_class | append: ' ' | append: include.class -%}
{%- endif -%}

{%- capture caption_html -%}{% if include.cap and include.cap != '' %}<figcaption>{{ include.cap }}</figcaption>{% endif %}{%- endcapture -%}

{%- if kind == 'img' -%}
<figure class="{{ figure_class }}">
  <img src="{{ url_rel }}"
       alt="{{ include.alt | default: '' | escape }}"
       loading="lazy" decoding="async"{% if include.width %} width="{{ include.width | escape }}"{% endif %}{% if include.height %} height="{{ include.height | escape }}"{% endif %}>
  {{ caption_html }}
</figure>

{%- elsif kind == 'audio' -%}
{%- assign mime = 'audio/' | append: ext -%}
{%- if ext == 'm4a' -%}{% assign mime = 'audio/mp4' %}{%- endif -%}
<figure class="{{ figure_class }}">
  <audio controls preload="{{ include.preload | default: 'metadata' }}">
    <source src="{{ url_rel }}" type="{{ mime }}">
    Ваш браузер не поддерживает аудио.
  </audio>
  {{ caption_html }}
</figure>

{%- elsif kind == 'video' -%}
{%- assign mime = 'video/' | append: ext -%}
{%- if ext == 'ogv' -%}{% assign mime = 'video/ogg' %}{%- endif -%}
<figure class="{{ figure_class }}">
  <video controls playsinline preload="{{ include.preload | default: 'metadata' }}"{{ poster_attr }}{% if include.autoplay %} autoplay{% endif %}{% if include.muted %} muted{% endif %}{% if include.loop %} loop{% endif %} style="max-width:100%">
    <source src="{{ url_rel }}" type="{{ mime }}">
    Ваш браузер не поддерживает видео.
  </video>
  {{ caption_html }}
</figure>

{%- else -%}
<p><a href="{{ url_rel }}">{{ f }}</a></p>
{%- endif -%}

{%- endunless -%}
