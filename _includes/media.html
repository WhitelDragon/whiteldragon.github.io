{%- comment -%}
Универсальная обёртка медиа (картинки — квадратные превью с раскрытием).

Как пользоваться (всегда полный путь):
  {% include media.html f="/assets/img/2025/slug/photo.jpg" alt="..." %}
  {% include media.html f="/assets/video/2025/slug/clip.mp4" poster="/assets/img/2025/slug/poster.jpg" %}
  {% include media.html f="/assets/audio/2025/slug/voice.m4a" %}

Параметры:
  f          — обязателен. Абсолютный путь (/assets/...) или http(s)
  alt, cap, class, width, height — стандартно
  poster     — для видео (абс. путь /assets... или URL)
  preload    — metadata|auto|none (по умолчанию metadata)
  autoplay, muted, loop — флаги для видео
  noexpand   — если указать, картинка не кликабельна
  full       — если указать, для этой картинки ОТКЛЮЧИТЬ квадратное превью (сразу полноразмерная)
  thumb      — размер плитки в px (по умолчанию 220). Пример: thumb=180
{%- endcomment -%}

{%- assign src = include.f | default: include.src | default: '' | strip -%}
{%- unless src == '' or src == nil -%}

  {%- assign ext = src | split: '.' | last | downcase -%}
  {%- assign is_http = src contains '://' -%}
  {%- if is_http -%}{% assign url = src %}{%- else -%}{% assign url = src | relative_url %}{%- endif -%}

  {%- assign img_exts = 'jpg,jpeg,png,webp,gif,avif,svg' | split: ',' -%}
  {%- assign vid_exts = 'mp4,webm,ogv' | split: ',' -%}
  {%- assign aud_exts = 'mp3,ogg,wav,m4a,flac' | split: ',' -%}

  {%- if img_exts contains ext -%}
    {%- assign kind = 'img' -%}
  {%- elsif vid_exts contains ext -%}
    {%- assign kind = 'video' -%}
  {%- elsif aud_exts contains ext -%}
    {%- assign kind = 'audio' -%}
  {%- else -%}
    {%- assign kind = 'file' -%}
  {%- endif -%}

  {%- assign figure_class = 'media media-' | append: kind -%}
  {%- if include.class and include.class != '' -%}
    {%- assign figure_class = figure_class | append: ' ' | append: include.class -%}
  {%- endif -%}

  {%- capture caption_html -%}{% if include.cap and include.cap != '' %}<figcaption>{{ include.cap }}</figcaption>{% endif %}{%- endcapture -%}

  {%- if kind == 'img' -%}
    {%- assign is_thumb = true -%}{% if include.full %}{% assign is_thumb = false %}{% endif -%}
    {%- capture thumb_style -%}{% if include.thumb %} style="--thumb-size: {{ include.thumb | append: 'px' }}"{% endif %}{%- endcapture -%}
    <figure class="{{ figure_class }}{% if is_thumb %} expandable thumb{% else %} expandable{% endif %}"{% if is_thumb %}{{ thumb_style }}{% endif %}{% unless include.noexpand %} tabindex="0" role="button" aria-expanded="false"{% endunless %}>
      <img src="{{ url }}"
           alt="{{ include.alt | default: '' | escape }}"
           loading="lazy" decoding="async"{% if include.width %} width="{{ include.width | escape }}"{% endif %}{% if include.height %} height="{{ include.height | escape }}"{% endif %}>
      {{ caption_html }}
    </figure>

    <!-- Вставляем стили и JS один раз -->
    <script>
    (function(){
      if (window.__expandableTilesInit) return;
      window.__expandableTilesInit = true;

      // Стили
      if (!document.getElementById('expandable-tiles-style')) {
        var css = `
:root{--thumb-size:220px}
.media.media-img{margin:.5rem}
.media.media-img img{display:block;max-width:100%;height:auto}
.media.media-img.expandable.thumb{
  width:var(--thumb-size); height:var(--thumb-size);
  overflow:hidden; border-radius:12px; display:inline-block; vertical-align:top;
  cursor:zoom-in; position:relative; background:#f3f4f6;
}
.media.media-img.expandable.thumb img{width:100%; height:100%; object-fit:cover; object-position:center;}
.media.media-img.expandable.thumb figcaption{display:none}
.media.media-img.expandable.thumb.expanded{
  width:auto; height:auto; display:block; margin:1rem 0; cursor:zoom-out;
}
.media.media-img.expandable.thumb.expanded img{width:100%; height:auto; object-fit:contain}
.media.media-img.expandable{outline:none}
        `.trim();
        var st=document.createElement('style'); st.id='expandable-tiles-style'; st.textContent=css; document.head.appendChild(st);
      }

      // Делегирование клика
      document.addEventListener('click', function(e){
        var fig = e.target.closest && e.target.closest('.media.media-img.expandable:not(.noexpand)');
        if (!fig) return;
        if (!fig.classList.contains('thumb')) return; // полноразмерные не переключаем
        fig.classList.toggle('expanded');
        fig.setAttribute('aria-expanded', fig.classList.contains('expanded') ? 'true' : 'false');
      });

      // Клавиатура
      document.addEventListener('keydown', function(e){
        if ((e.key === 'Enter' || e.key === ' ') && e.target.matches && e.target.matches('.media.media-img.expandable.thumb')) {
          e.preventDefault();
          e.target.classList.toggle('expanded');
          e.target.setAttribute('aria-expanded', e.target.classList.contains('expanded') ? 'true' : 'false');
        }
      });
    })();
    </script>

  {%- elsif kind == 'audio' -%}
    {%- assign mime = 'audio/' | append: ext -%}
    {%- if ext == 'm4a' -%}{% assign mime = 'audio/mp4' %}{%- endif -%}
    <figure class="{{ figure_class }}">
      <audio controls preload="{{ include.preload | default: 'metadata' }}">
        <source src="{{ url }}" type="{{ mime }}">
        Ваш браузер не поддерживает аудио.
      </audio>
      {{ caption_html }}
    </figure>

  {%- elsif kind == 'video' -%}
    {%- assign mime = 'video/' | append: ext -%}
    {%- if ext == 'ogv' -%}{% assign mime = 'video/ogg' %}{%- endif -%}
    {%- assign poster_attr = '' -%}
    {%- if include.poster and include.poster != '' -%}
      {%- assign p = include.poster | strip -%}
      {%- if p contains '://' -%}{% assign poster_url = p %}{%- else -%}{% assign poster_url = p | relative_url %}{%- endif -%}
      {%- assign poster_attr = ' poster="' | append: poster_url | append: '"' -%}
    {%- endif -%}
    <figure class="{{ figure_class }}">
      <video controls playsinline
             preload="{{ include.preload | default: 'metadata' }}"{{ poster_attr }}{% if include.autoplay %} autoplay{% endif %}{% if include.muted %} muted{% endif %}{% if include.loop %} loop{% endif %}
             style="max-width:100%">
        <source src="{{ url }}" type="{{ mime }}">
        Ваш браузер не поддерживает видео.
      </video>
      {{ caption_html }}
    </figure>

  {%- else -%}
    <p><a href="{{ url }}">{{ src }}</a></p>
  {%- endif -%}

{%- endunless -%}
